<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width" />
    <title>Video test page</title>
  </head>

  <body style="border: black 1px solid; width: 100%">
    <button onclick="start()">Start</button>
    <div>
      <p>SRC</p>
      <video
        id="src_video"
        width="160px"
        height="120px"
        crossorigin="anonymous"
        muted
        src="https://storage.googleapis.com/gtv-videos-bucket/sample/BigBuckBunny.mp4"
      ></video>
    </div>
    <div>
      <p>DST</p>
      <video id="dst_video" width="500" height="300"></video>
    </div>
    <div>
      <p>cv</p>
      <canvas id="canvasOutput"></canvas>
    </div>
    <script src="./src/opencv/utils.js" type="text/javascript"></script>
    <script>
      const W = 320;
      const H = 240;

      function start() {
        const srcVideo = document.getElementById("src_video");
        const dstVideo = document.getElementById("dst_video");
        buildVSRPipleline(srcVideo, dstVideo, createTransform());

        srcVideo.play();
        dstVideo.play();
      }

      function buildVSRPipleline(srcVideo, dstVideo, vsrTransformer) {
        const srcTrack = getVideoTrack(srcVideo);
        const trackProcessor = new MediaStreamTrackProcessor({
          track: srcTrack,
        });
        const trackGenerator = new MediaStreamTrackGenerator({ kind: "video" });

        trackProcessor.readable
          .pipeThrough(vsrTransformer)
          .pipeTo(trackGenerator.writable);

        const outStream = new MediaStream([trackGenerator]);
        dstVideo.srcObject = outStream;
      }

      function createTransform() {
        return new TransformStream({
          async transform(videoFrame, controller) {
            const buffer = new Uint8Array(videoFrame.allocationSize());
            const layout = await videoFrame.copyTo(buffer);
            const l = buffer.length / 4;
            console.log(buffer, layout);
            for (let i = 0; i < l; i++) {
              const grey =
                (buffer[i * 4 + 0] + buffer[i * 4 + 1] + buffer[i * 4 + 2]) / 3;

              buffer[i * 4 + 0] = grey;
              buffer[i * 4 + 1] = grey;
              buffer[i * 4 + 2] = grey;
            }

            const init = {
              timestamp: videoFrame.timestamp,
              codedWidth: videoFrame.codedWidth / 2,
              codedHeight: videoFrame.codedHeight / 2,
              format: videoFrame.format,
            };

            const newFrame = new VideoFrame(buffer, init);
            videoFrame.close();
            controller.enqueue(newFrame);
          },
        });
      }

      function getVideoTrack(video) {
        const [track] = video.captureStream().getVideoTracks();
        video.onended = (evt) => track.stop();
        return track;
      }
    </script>
    <script async src="./src/opencv/opencv.js" type="text/javascript"></script>
  </body>
</html>
